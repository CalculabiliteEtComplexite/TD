# -------------------------------
# Configuration
# -------------------------------

SHELL    := bash
SRCDIR   := src/CEC
BUILDDIR := build
DOCSDIR  := docs

# LaTeX drivers from $(SRCDIR)
TEXS    := td
PDFS    := $(addsuffix .pdf,$(TEXS))

# Choose engine (override with: make PDFLATEX=xelatex)
PDFLATEX ?= pdflatex
PDFLATEX_FLAGS := -halt-on-error -interaction=nonstopmode -output-directory=$(BUILDDIR)

# Latex-libs library (local clone + TEXINPUTS)
LATEX_LIBS_DIR	 := latex-libs
LATEX_LIBS_SSH_URL   := git@github.com:MatthieuPerrin/Latex-libs.git
LATEX_LIBS_HTTPS_URL := https://github.com/MatthieuPerrin/Latex-libs.git

# TD-corrections library (local clone + TEXINPUTS)
TD_CORRECTIONS_REPO := git@github.com:CalculabiliteEtComplexite/TD-corrections.git
TD_CORRECTIONS_DIR  := src/corrections

# Path separator (Windows vs Unix)
ifeq ($(OS),Windows_NT)
  PATHSEP := ;
else
  PATHSEP := :
endif

# Add latex-libs to TeX search path (recursive with //); keep default path via trailing sep
export TEXINPUTS := $(CURDIR)/$(LATEX_LIBS_DIR)//$(PATHSEP)$(TEXINPUTS)//$(PATHSEP)$(TEXINPUTS)

# -------------------------------
# Main targets
# -------------------------------

.PHONY: all td correction deps depscorr update clean cleanall help

# Aliases to build each PDF
td: $(DOCSDIR)/td.pdf
correction: depscorr $(DOCSDIR)/correction.pdf
all: td correction

# Generic rule: build docs/%.pdf from src/drivers/%.tex
$(DOCSDIR)/%.pdf: $(SRCDIR)/%.tex FORCE | $(BUILDDIR) $(DOCSDIR) deps
	$(PDFLATEX) $(PDFLATEX_FLAGS) $<
	$(PDFLATEX) $(PDFLATEX_FLAGS) $<   # second pass for cross-refs
	@mv $(BUILDDIR)/$*.pdf $@

FORCE:

# -------------------------------
# Dependencies management (latex-libs)
# -------------------------------

# Ensure local clone exists (used as a prerequisite by build rules)
deps:
	@if [ ! -d "$(LATEX_LIBS_DIR)/.git" ]; then \
	  echo ">>> Cloning latex-libs into $(LATEX_LIBS_DIR)"; \
	  ( git clone --depth 1 "$(LATEX_LIBS_SSH_URL)"   "$(LATEX_LIBS_DIR)" 2>/dev/null \
	    || git clone --depth 1 "$(LATEX_LIBS_HTTPS_URL)" "$(LATEX_LIBS_DIR)" ); \
	fi

depscorr:
	@if [ ! -d "$(TD_CORRECTIONS_DIR)/.git" ]; then \
	  echo ">>> Cloning TD-corrections into $(TD_CORRECTIONS_DIR)"; \
	  git clone --depth 1 $(TD_CORRECTIONS_REPO) $(TD_CORRECTIONS_DIR) || { \
	    echo ">>> ERROR: impossible to clone TD-corrections (SSH key/token ?)"; exit 1; }; \
	fi

# Update both the main repo and the local dependency clone
update:
	@echo ">>> Updating main repository"; \
	git pull --ff-only || echo ">>> Skipping main repo update (offline or non-fast-forward)."; \
	if [ -d "$(LATEX_LIBS_DIR)/.git" ]; then \
	  echo ">>> Updating $(LATEX_LIBS_DIR)"; \
	  git -C $(LATEX_LIBS_DIR) pull --ff-only || echo ">>> Skipping latex-libs update (offline or non-fast-forward)."; \
	else \
	  echo ">>> latex-libs not present; run 'make deps' when online."; \
	fi
	if [ -d "$(TD_CORRECTIONS_DIR)/.git" ]; then \
	  echo ">>> Updating $(TD_CORRECTIONS_DIR)"; \
	  git -C $(TD_CORRECTIONS_DIR) pull --ff-only || echo ">>> Skipping TD-corrections update (offline or non-fast-forward)."; \
	fi

# -------------------------------
# Create folders
# -------------------------------

$(BUILDDIR):
	@mkdir -p $@

$(DOCSDIR):
	@mkdir -p $@

# -------------------------------
# Cleaning
# -------------------------------

clean:
	@rm -rf $(BUILDDIR)/*

cleanall: clean
	@rm -f $(DOCSDIR)/*.pdf

# -------------------------------
# Help
# -------------------------------

help:
	@echo "Usage:"
	@echo "  make            – Build docs/td.pdf"
	@echo "  make td         – Build docs/td.pdf"
	@echo "  make correction – Build docs/correction.pdf (nécessite l'accès au repo privé)"
	@echo "  make update     – Update local project and LaTeX-libs (git pull)"
	@echo "  make clean      – Remove build artifacts"
	@echo "  make cleanall   – Also remove generated PDFs"
